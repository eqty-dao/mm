<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BTC/USDT ¬∑ KuCoin ¬∑ Testing</title>
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <style>

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-running {
      background: #10b981;
      color: white;
    }

    .status-stopped {
      background: #ef4444;
      color: white;
    }

    .status-unknown {
      background: #6b7280;
      color: white;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      color: #333;
      font-size: 20px;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .container-list {
      display: grid;
      gap: 15px;
    }

    .container-item {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .container-name {
      font-weight: 600;
      color: #333;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .container-details {
      font-size: 14px;
      color: #6b7280;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 15px;
      border-radius: 8px;
    }

    .warning {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      color: #92400e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .last-update {
      text-align: right;
      color: black;
      font-size: 14px;
      margin-top: 10px;
    }

    .refresh-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }

    .nav-grid { display:grid; grid-template-columns:repeat(4,auto); grid-template-rows:auto auto; gap:6px 10px; justify-content:start; margin-top:10px; margin-bottom:5px; }
    .tab { background:#e5e7eb; border:none; border-radius:999px; padding:6px 16px; font-size:14px; cursor:pointer; color:#374151; transition:background 0.2s,color 0.2s; }
    .tab.active { background:#4f46e5; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Tables for trades */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #eff6ff;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .pill-buy {
      background: #dcfce7;
      color: #15803d;
    }

    .pill-sell {
      background: #fee2e2;
      color: #b91c1c;
    }

    .pnl-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(128px,1fr));gap:10px;overflow:visible;}
    .pnl-stat{position:relative;overflow:visible;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px 10px;text-align:center;}
    .pnl-stat .label{font-size:11px;color:#9ca3af;text-transform:uppercase;font-weight:700;letter-spacing:.05em;margin-bottom:4px;}
    .pnl-stat .value{font-size:16px;font-weight:700;color:#111827;line-height:1.2;}
    .pnl-stat .sub{font-size:11px;color:#9ca3af;margin-top:3px;}
    .pnl-stat.positive{border-color:#86efac;background:#f0fdf4;} .pnl-stat.positive .value{color:#15803d;}
    .pnl-stat.negative{border-color:#fca5a5;background:#fef2f2;} .pnl-stat.negative .value{color:#dc2626;}
    .pnl-stat.neutral .value{color:#1e40af;} .pnl-stat.highlight{border-width:2px;}
    .stat-help{display:inline-flex;align-items:center;justify-content:center;width:12px;height:12px;cursor:pointer;color:#9ca3af;vertical-align:middle;margin-left:2px;position:relative;user-select:none;flex-shrink:0;-webkit-tap-highlight-color:transparent;transition:color 0.15s;}
    .stat-help::before{content:'';position:absolute;top:-8px;bottom:-8px;left:-8px;right:-8px;}
    .stat-help:hover{color:#4f46e5;}
    .stat-help:hover .stat-tip,.stat-help.open .stat-tip{display:block;}
    .stat-tip{display:none;position:absolute;bottom:calc(100% + 7px);left:50%;transform:translateX(-50%);background:#1f2937;color:#f9fafb;font-size:11px;font-weight:400;line-height:1.5;padding:8px 11px;border-radius:6px;width:200px;max-width:min(200px,80vw);text-align:left;z-index:200;box-shadow:0 4px 14px rgba(0,0,0,0.4);white-space:normal;pointer-events:none;}
    .stat-tip::after{content:'';position:absolute;top:100%;left:50%;transform:translateX(-50%);border:5px solid transparent;border-top-color:#1f2937;}
    [data-theme="dark"] .stat-help{color:#6e7681;}
    [data-theme="dark"] .stat-help:hover{color:#79c0ff;}
    [data-theme="dark"] .stat-tip{background:#161b22;color:#e6edf3;}
    [data-theme="dark"] .stat-tip::after{border-top-color:#161b22;}
    .uptime-bar{display:flex;align-items:center;gap:12px;flex-wrap:wrap;padding:10px 14px;border-radius:8px;margin-bottom:16px;border:1px solid #e5e7eb;background:#f9fafb;font-size:13px;}
    .uptime-bar.good{background:#f0fdf4;border-color:#86efac;color:#15803d;}
    .uptime-bar.down{background:#fef2f2;border-color:#fca5a5;color:#dc2626;}
    .uptime-bar .ub-status{font-weight:700;font-size:14px;}
    .uptime-bar .ub-sep{color:#d1d5db;}
    .uptime-bar .ub-label{font-size:11px;color:#9ca3af;text-transform:uppercase;letter-spacing:.05em;}
    .uptime-bar .ub-val{font-weight:600;}
    [data-theme="dark"] .uptime-bar{background:#21262d;border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .uptime-bar.good{background:#0d2818;border-color:#238636;color:#3fb950;}
    [data-theme="dark"] .uptime-bar.down{background:#2d1515;border-color:#6d2626;color:#f85149;}
    [data-theme="dark"] .uptime-bar .ub-sep{color:#30363d;}
    [data-theme="dark"] .uptime-bar .ub-label{color:#6e7681;}
    .hm-wrap{overflow-x:auto;padding-bottom:4px;}
    .hm-row{display:flex;align-items:center;margin-bottom:2px;}
    .hm-label{width:46px;font-size:10px;color:#8b949e;text-align:right;padding-right:6px;flex-shrink:0;white-space:nowrap;}
    .hm-cell{border-radius:3px;cursor:default;transition:opacity .1s;flex-shrink:0;}
    .hm-cell.has-trades{cursor:pointer;}
    .hm-cell.has-trades:hover{opacity:.75;outline:2px solid rgba(255,255,255,.5);}
    .hm-cell.selected{outline:2px solid #4f46e5!important;opacity:1!important;}
    .hm-detail{margin-top:14px;border-radius:8px;border:1px solid #e5e7eb;overflow:hidden;}
    .hm-detail-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f3f4f6;font-size:13px;font-weight:600;}
    .hm-detail-close{cursor:pointer;font-size:16px;line-height:1;padding:0 4px;opacity:.6;}
    .hm-detail-close:hover{opacity:1;}
    .hm-detail table{width:100%;border-collapse:collapse;font-size:12px;}
    .hm-detail td{padding:5px 10px;border-bottom:1px solid #f3f4f6;}
    [data-theme="dark"] .hm-detail{border-color:#30363d;}
    [data-theme="dark"] .hm-detail-header{background:#21262d;color:#e6edf3;}
    [data-theme="dark"] .hm-detail td{border-bottom-color:#21262d;color:#e6edf3;}
    .activity-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(380px,1fr));gap:16px;}
    .days-selector{display:inline-flex;gap:5px;float:right;}
    .days-btn{padding:3px 12px;border-radius:999px;border:1px solid #d1d5db;background:white;font-size:12px;font-weight:600;color:#374151;cursor:pointer;transition:all .15s;}
    .days-btn:hover{background:#f3f4f6;} .days-btn.active{background:#4f46e5;color:white;border-color:#4f46e5;}
    .uptime-chip{display:inline-flex;align-items:center;gap:5px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 12px;font-size:12px;color:#374151;white-space:nowrap;}
    .uptime-chip.good{background:#f0fdf4;border-color:#86efac;color:#15803d;}
    .uptime-chip.warn{background:#fffbeb;border-color:#fcd34d;color:#92400e;}
    .uptime-chip.down{background:#fef2f2;border-color:#fca5a5;color:#dc2626;}
    .uptime-chip strong{font-weight:700;}
    .theme-toggle-btn{background:none;border:1px solid #d1d5db;border-radius:999px;padding:5px 12px;font-size:15px;cursor:pointer;transition:all .2s;line-height:1;align-self:flex-start;margin-top:10px;}
    .theme-toggle-btn:hover{transform:scale(1.1);}
    [data-theme="dark"] body{background:#0d1117;}
    [data-theme="dark"] header,[data-theme="dark"] .card{background:#161b22;box-shadow:0 4px 12px rgba(0,0,0,.5);}
    [data-theme="dark"] h1,[data-theme="dark"] .card h2,[data-theme="dark"] .container-name{color:#f0f6fc;}
    [data-theme="dark"] .card h2{border-bottom-color:#4f46e5;}
    [data-theme="dark"] .container-details,[data-theme="dark"] .last-update,[data-theme="dark"] .loading{color:#8b949e;}
    [data-theme="dark"] .container-item{background:#21262d;border-left-color:#4f46e5;}
    [data-theme="dark"] .error{background:#2d1515;border-color:#6d2626;color:#f87171;}
    [data-theme="dark"] .warning{background:#2d2208;border-color:#78350f;color:#fcd34d;}
    [data-theme="dark"] .refresh-info{background:#1c2947;border-color:#2d4a7a;color:#93c5fd;}
    [data-theme="dark"] .tab{background:#21262d;color:#8b949e;}
    [data-theme="dark"] .tab.active{background:#4f46e5;color:white;}
    [data-theme="dark"] th{background:#21262d;color:#e6edf3;}
    [data-theme="dark"] th,[data-theme="dark"] td{border-bottom-color:#30363d;color:#e6edf3;}
    [data-theme="dark"] tbody tr:nth-child(even){background:#1c2128;}
    [data-theme="dark"] tbody tr:nth-child(odd){background:#161b22;}
    [data-theme="dark"] tbody tr:hover{background:#272e38;}
    [data-theme="dark"] pre{background:#0d1117;border:1px solid #30363d;}
    [data-theme="dark"] .pill-buy{background:#0d2818;color:#3fb950;}
    [data-theme="dark"] .pill-sell{background:#2d1515;color:#f85149;}
    [data-theme="dark"] .pnl-stat{background:#21262d;border-color:#30363d;}
    [data-theme="dark"] .pnl-stat .label{color:#8b949e;} [data-theme="dark"] .pnl-stat .value{color:#e6edf3;} [data-theme="dark"] .pnl-stat .sub{color:#6e7681;}
    [data-theme="dark"] .pnl-stat.positive{background:#0d2818;border-color:#238636;} [data-theme="dark"] .pnl-stat.positive .value{color:#3fb950;}
    [data-theme="dark"] .pnl-stat.negative{background:#2d1515;border-color:#6d2626;} [data-theme="dark"] .pnl-stat.negative .value{color:#f85149;}
    [data-theme="dark"] .pnl-stat.neutral .value{color:#79c0ff;}
    [data-theme="dark"] .days-btn{background:#21262d;border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .days-btn:hover{background:#2d3748;} [data-theme="dark"] .days-btn.active{background:#4f46e5;color:white;border-color:#4f46e5;}
    [data-theme="dark"] .uptime-chip{background:#21262d;border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .uptime-chip.good{background:#0d2818;border-color:#238636;color:#3fb950;}
    [data-theme="dark"] .uptime-chip.warn{background:#2d2208;border-color:#78350f;color:#fcd34d;}
    [data-theme="dark"] .uptime-chip.down{background:#2d1515;border-color:#6d2626;color:#f85149;}
    [data-theme="dark"] .theme-toggle-btn{border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .theme-toggle-btn:hover{background:#21262d;}
    [data-theme="dark"] .status-unknown{background:#3d444d;}
    [data-theme="dark"] .hm-label{color:#6e7681;}
  
  
    .tabs{display:flex;gap:6px;margin-bottom:16px;flex-wrap:wrap;}
    .tab{padding:6px 14px;border-radius:6px;border:1px solid #e5e7eb;background:transparent;cursor:pointer;font-size:13px;font-weight:500;color:#6b7280;transition:all .15s;}
    .tab:hover{background:#f3f4f6;} .tab.active{background:#4f46e5;border-color:#4f46e5;color:#fff;}
    [data-theme="dark"] .tab{border-color:#30363d;color:#8b949e;}
    [data-theme="dark"] .tab:hover{background:#21262d;}
    [data-theme="dark"] .tab.active{background:#4f46e5;border-color:#4f46e5;color:#fff;}
    .tab-content{display:none;} .tab-content.active{display:block;}
    .hm-wrap{overflow-x:auto;padding-bottom:4px;}
    .hm-row{display:flex;align-items:center;margin-bottom:2px;}
    .hm-label{width:46px;font-size:10px;color:#8b949e;text-align:right;padding-right:6px;flex-shrink:0;white-space:nowrap;}
    .hm-cell{border-radius:3px;cursor:default;transition:opacity .1s;flex-shrink:0;}
    .hm-cell.has-trades{cursor:pointer;} .hm-cell.has-trades:hover{opacity:.75;outline:2px solid rgba(255,255,255,.5);}
    .hm-cell.selected{outline:2px solid #4f46e5!important;opacity:1!important;}
    .hm-detail{margin-top:14px;border-radius:8px;border:1px solid #e5e7eb;overflow:hidden;}
    .hm-detail-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px;background:#f3f4f6;font-size:13px;font-weight:600;}
    .hm-detail-close{cursor:pointer;font-size:16px;line-height:1;padding:0 4px;opacity:.6;} .hm-detail-close:hover{opacity:1;}
    .hm-detail table{width:100%;border-collapse:collapse;font-size:12px;}
    .hm-detail td{padding:5px 10px;border-bottom:1px solid #f3f4f6;}
    [data-theme="dark"] .hm-detail{border-color:#30363d;}
    [data-theme="dark"] .hm-detail-header{background:#21262d;color:#e6edf3;}
    [data-theme="dark"] .hm-detail td{border-bottom-color:#21262d;color:#e6edf3;}
    [data-theme="dark"] .hm-label{color:#6e7681;}
  </style>
  <script>
    (function(){var t=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',t);})()
  </script>
</head>
<body>
<div class="container">

  <header>
    <div style="display:flex;justify-content:space-between;align-items:flex-start;">
      <div>
        <h1 id="page-title">üß™ BTC/USDT &middot; KuCoin &middot; Testing</h1>
        <div style="display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap;">
          <span id="bot-status-badge" class="status-badge status-unknown">Checking...</span>
          <span style="font-size:12px;color:#6b7280;font-family:monospace;">
            Bot&nbsp;843b01597349&hellip; &middot; UID&nbsp;1217248639 &middot; BTC-USDT
          </span>
        </div>
      </div>
      <button id="theme-toggle" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme">&#9728;&#65039;</button>
    </div>
  </header>
  <div class="tabs">
    <button class="tab active" data-tab="overview" onclick="showBtcTab('overview')">Overview</button>
    <button class="tab"        data-tab="activity" onclick="showBtcTab('activity')">&#128200; Activity</button>
  </div>

  <!-- Balance -->
  <div id="tab-overview" class="tab-content active">
  <div class="card">
    <h2>KuCoin Balance</h2>
    <div id="btc-balance" class="loading">Loading KuCoin balance...</div>
  </div>

  <!-- Bot Status -->
  <div class="card">
    <h2>Bot Status</h2>
    <div id="btc-bot-status" class="loading">Loading...</div>
  </div>

  <!-- P&L -->
  <div class="card">
    <h2>P&amp;L Summary
      <span class="days-selector">
        <button class="days-btn active" data-days="1"  onclick="loadTradeData(1)">1D</button>
        <button class="days-btn"        data-days="7"  onclick="loadTradeData(7)">7D</button>
        <button class="days-btn"        data-days="30" onclick="loadTradeData(30)">30D</button>
      </span>
    </h2>
    <div id="btc-pnl" class="loading">Loading P&amp;L...</div>
  </div>

  <!-- Trades -->
  <div class="card">
    <h2>KuCoin Trades</h2>
    <div id="btc-content" class="loading">Loading trades...</div>
  </div>

  <div class="last-update" id="last-update"></div>
  </div>


  <div id="tab-activity" class="tab-content">
    <div class="card">
      <h2>&#128200; BTC/USDT Activity &middot; KuCoin
        <span class="days-selector" id="activity-btc-days">
          <button class="days-btn"        data-days="7"  onclick="loadActivityBtc(7)">7D</button>
          <button class="days-btn active" data-days="14" onclick="loadActivityBtc(14)">14D</button>
          <button class="days-btn"        data-days="30" onclick="loadActivityBtc(30)">30D</button>
        </span>
      </h2>
      <div id="activity-btc" class="loading">Loading heatmap...</div>
      <div id="activity-btc-detail"></div>
    </div>
  </div>
</div><!-- /container -->

<script>
  const API_BASE = 'https://btc-proxy.eqtydao.workers.dev';


  // Generic fetch via proxy
  async function fetchWithAuth(endpoint) {
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return await response.json();
    }


  // ‚îÄ‚îÄ Uptime tracking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const UPTIME_CONFIG={testing:{start:new Date('2026-02-22T00:00:00')}};
    const REFRESH_INTERVAL = 120000;
    function _dk(ex){return`uptime_down_s_${ex}`;}
  
    function trackDowntime(ex,ok){if(!ok){const k=_dk(ex);localStorage.setItem(k,parseInt(localStorage.getItem(k)||'0')+Math.round(REFRESH_INTERVAL/1000));}}
  function getUptimeStats(ex){
      const cfg=UPTIME_CONFIG[ex];if(!cfg?.start)return null;
      const tot=(Date.now()-cfg.start.getTime())/1000,dn=parseInt(localStorage.getItem(_dk(ex))||'0'),up=Math.max(0,tot-dn);
      return{d:Math.floor(up/86400),h:Math.floor((up%86400)/3600),m:Math.floor((up%3600)/60),pct:(up/tot)*100};
    }

  // ‚îÄ‚îÄ Theme ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function toggleTheme(){
    const h=document.documentElement,n=(h.getAttribute('data-theme')||'dark')==='dark'?'light':'dark';
    h.setAttribute('data-theme',n);localStorage.setItem('theme',n);
    const b=document.getElementById('theme-toggle');if(b)b.textContent=n==='dark'?'\u2600\uFE0F':'\uD83C\uDF19';
  }
  document.addEventListener('DOMContentLoaded',()=>{
    const s=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',s);
    const b=document.getElementById('theme-toggle');if(b)b.textContent=s==='dark'?'\u2600\uFE0F':'\uD83C\uDF19';
  });
  document.addEventListener('click',()=>document.querySelectorAll('.stat-help.open').forEach(el=>el.classList.remove('open')));

  // ‚îÄ‚îÄ Renders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderTradesTable(containerId, trades) {
  const container = document.getElementById(containerId);

  if (!Array.isArray(trades) || trades.length === 0) {
    container.innerHTML = '<div style="color:#6b7280; text-align:center;">No trades found</div>';
    return;
  }

  const rows = trades.map(t => {
    const dt = new Date(t.trade_timestamp || t.timestamp || Date.now());
    const side = (t.trade_type || t.side || '').toUpperCase();
    const sideClass = side === 'BUY' ? 'pill pill-buy' : 'pill pill-sell';

    const rawQty = t.quantity ?? t.amount ?? '';
    const cleanQty = typeof rawQty === 'string'
      ? rawQty.replace(/\.$/, '')
      : rawQty;

    return `
      <tr>
        <td>${dt.toLocaleString()}</td>
        <td>${t.symbol || '-'}</td>
        <td><span class="${sideClass}">${side || '-'}</span></td>
        <td>${t.price ?? '-'}</td>
        <td>${cleanQty || '-'}</td>
        <td>${t.market || t.exchange || '-'}</td>
      </tr>
    `;
  }).join('');

  container.innerHTML = `
    <div style="overflow-x:auto; max-height: 600px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
      <table>
        <thead style="position: sticky; top: 0; background: #eff6ff; z-index: 10;">
          <tr>
            <th>Time</th>
            <th>Pair</th>
            <th>Side</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Market</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 10px; text-align: center; color: #6b7280; font-size: 13px;">
      Showing ${trades.length} trade${trades.length !== 1 ? 's' : ''}
    </div>
  `;
}

  function renderBalanceTable(containerId, balances) {
  const el = document.getElementById(containerId);

  if (!Array.isArray(balances) || balances.length === 0) {
    el.innerHTML = '<div style="color:#6b7280; text-align:center;">No balance data</div>';
    return;
  }

  const rows = balances.map(b => `
    <tr>
      <td>${b.token || '-'}</td>
      <td>${b.units ?? '-'}</td>
      <td>${b.available_units ?? '-'}</td>
      <td>${b.price ?? '-'}</td>
      <td>${b.value ?? '-'}</td>
    </tr>
  `).join('');

  el.innerHTML = `
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Token</th>
            <th>Total</th>
            <th>Available</th>
            <th>Price</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
  `;
}

  function computePnlStats(trades){
      let bv=0,bq=0,bc=0,sv=0,sq=0,sc=0,fees=0;
      for(const t of trades){
        const p=parseFloat(t.price)||0,q=parseFloat(String(t.quantity??'').replace(/\.$/,''))||0;
        const f=parseFloat(t.raw_json?.trade_fee?.percent??'0.003'),n=p*q;
        fees+=n*f;
        if((t.trade_type||'').toUpperCase()==='BUY'){bv+=n;bq+=q;bc++;}else{sv+=n;sq+=q;sc++;}
      }
      const avgBuy=bq>0?bv/bq:0,avgSell=sq>0?sv/sq:0;
      const spread=(avgBuy>0&&avgSell>0)?avgSell-avgBuy:0,spreadBps=avgBuy>0&&spread!==0?(spread/avgBuy)*10000:0;
      return{buyVolume:bv,buyQty:bq,buyCount:bc,sellVolume:sv,sellQty:sq,sellCount:sc,
        totalFees:fees,tradePnl:sv-bv,netPnl:sv-bv-fees,totalVolume:bv+sv,totalEqtyVol:bq+sq,
        avgBuyPrice:avgBuy,avgSellPrice:avgSell,netEqtyChange:bq-sq,tradeCount:trades.length,spread,spreadBps};
    }

  function renderPnlStats(id,s,pv,mp){
      const el=document.getElementById(id);if(!el)return;
      const ret=pv>0?(s.netPnl/pv)*100:null,tpnl=mp>0?s.netPnl+(s.netEqtyChange*mp):null;
      const fmt=(n,d=4)=>n===null?'\u2014':(n>=0?`+$${Math.abs(n).toFixed(d)}`:`-$${Math.abs(n).toFixed(d)}`);
      const fp=n=>n===null?'\u2014':`${n>=0?'+':''}${n.toFixed(3)}%`;
      const cls=n=>n===null?'neutral':n>=0?'positive':'negative';
      const ic=s.netEqtyChange>0?'positive':s.netEqtyChange<0?'negative':'neutral';
      const sc2=s.spread>0?'positive':s.spread<0?'negative':'neutral';
      const tip=t=>`<span class="stat-help" onclick="event.stopPropagation();this.classList.toggle('open')"><svg width="11" height="11" viewBox="0 0 11 11" fill="none" style="display:block;pointer-events:none" aria-hidden="true"><circle cx="5.5" cy="5.5" r="5" stroke="currentColor" stroke-width="1"/><rect x="5" y="5" width="1" height="3.2" rx="0.5" fill="currentColor"/><rect x="5" y="2.5" width="1" height="1.3" rx="0.5" fill="currentColor"/></svg><span class="stat-tip">${t}</span></span>`;
      el.innerHTML=`<div class="pnl-grid">
        <div class="pnl-stat neutral"><div class="label">Trades ${tip('Number of executed trades (B\u202f=\u202fbuys, S\u202f=\u202fsells)')}</div><div class="value">${s.tradeCount}</div><div class="sub">${s.buyCount}B / ${s.sellCount}S</div></div>
        <div class="pnl-stat neutral"><div class="label">Volume ${tip('Total notional value traded in USDT')}</div><div class="value">$${s.totalVolume.toFixed(2)}</div><div class="sub">notional USDT</div></div>
        <div class="pnl-stat neutral"><div class="label">BTC Vol ${tip('Total BTC moved')}</div><div class="value">${s.totalEqtyVol.toFixed(6)}</div><div class="sub">tokens moved</div></div>
        <div class="pnl-stat neutral"><div class="label">Avg Buy ${tip('Weighted avg price per BTC across all buys')}</div><div class="value">${s.avgBuyPrice>0?s.avgBuyPrice.toFixed(2):'\u2014'}</div><div class="sub">${s.buyQty.toFixed(6)} BTC</div></div>
        <div class="pnl-stat neutral"><div class="label">Avg Sell ${tip('Weighted avg price per BTC across all sells')}</div><div class="value">${s.avgSellPrice>0?s.avgSellPrice.toFixed(2):'\u2014'}</div><div class="sub">${s.sellQty.toFixed(6)} BTC</div></div>
        <div class="pnl-stat ${sc2} highlight"><div class="label">Spread Capture ${tip('Avg Sell \u2212 Avg Buy \u2014 core MM metric')}</div><div class="value">${s.spread>=0?'+':''}${s.spread.toFixed(2)}</div><div class="sub">${s.spreadBps>=0?'+':''}${s.spreadBps.toFixed(1)} bps</div></div>
        <div class="pnl-stat ${cls(s.tradePnl)}"><div class="label">Trade P&L ${tip('Sell revenue minus buy cost (pre-fee)')}</div><div class="value">${fmt(s.tradePnl)}</div><div class="sub">gross (pre-fee)</div></div>
        <div class="pnl-stat negative"><div class="label">Fees Paid ${tip('Total fees paid to the exchange')}</div><div class="value">-$${s.totalFees.toFixed(4)}</div><div class="sub">${s.totalVolume>0?(s.totalFees/s.totalVolume*100).toFixed(2):0}% effective</div></div>
        <div class="pnl-stat ${cls(s.netPnl)} highlight"><div class="label">Net P&L ${tip('Trade P&L after all fees')}</div><div class="value">${fmt(s.netPnl)}</div><div class="sub">after fees</div></div>
        <div class="pnl-stat ${cls(tpnl)} highlight"><div class="label">True P&L ${tip('Net P&L + unsold BTC at mid price')}</div><div class="value">${fmt(tpnl)}</div><div class="sub" style="font-size:10px;">${mp>0?`inv ${s.netEqtyChange>=0?'+':''}${Math.abs(s.netEqtyChange).toFixed(6)} @ ${mp.toFixed(6)}`:'load bot status first'}</div></div>
        <div class="pnl-stat ${cls(ret)} highlight"><div class="label">Return % ${tip('Net P&L as % of portfolio value')}</div><div class="value">${fp(ret)}</div><div class="sub">${pv>0?`on $${pv.toFixed(0)}`:'load balance first'}</div></div>
        <div class="pnl-stat ${ic}"><div class="label">Net BTC Œî ${tip('Net BTC change: positive = accumulating')}</div><div class="value">${s.netEqtyChange>=0?'+':''}${Math.abs(s.netEqtyChange).toFixed(6)}</div><div class="sub">${s.netEqtyChange>0?'\u2191 accumulating':s.netEqtyChange<0?'\u2193 distributing':'= neutral'}</div></div>
      </div>`;
    }

  // ‚îÄ‚îÄ API helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchBotStatus(botName) {
      const endpoint = `/bot-orchestration/${botName}/status`;
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

  async function fetchOrderBook(connector, pair) {
      const endpoint = '/market-data/order-book';
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          connector_name: connector,
          trading_pair: pair
        })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

  async function fetchPortfolioState(accountNames, connectorNames) {
      const endpoint = '/portfolio/state';
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          account_names: accountNames,
          connector_names: connectorNames,
          skip_gateway: false,
          refresh: true
        })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }


  // ‚îÄ‚îÄ Order parsing & asset metrics (BTC-specific) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function parseBtcOrders(logs) {
      const orderPattern = /Created (LIMIT_MAKER|LIMIT) (BUY|SELL) order (\S+) for ([\d.]+) BTC-USDT at ([\d.]+)/;
      const uniqueOrders = new Map();

      for (let i = logs.length - 1; i >= 0; i--) {
        const log = logs[i];
        const msg = log.msg || '';
        const match = msg.match(orderPattern);

        if (match) {
          const [, orderType, side, orderId, amount, price] = match;
          const priceLevel = parseFloat(price).toFixed(6);
          const key = `${side}_${priceLevel}`;

          if (!uniqueOrders.has(key)) {
            uniqueOrders.set(key, {
              orderType,
              side,
              orderId,
              amount: parseFloat(amount),
              price: parseFloat(price),
              timestamp: log.timestamp
            });
          }
        }
      }

      return Array.from(uniqueOrders.values());
    }


  function calculateBtcMetrics(balances, midPrice) {
      if (!balances || !balances.length) {
        const btcZ={total:0,available:0,currentValue:0,targetValue:0,currentPct:0,targetPct:40,orderAdjust:0,inventoryRange:'21% - 59%'};
        const usdtZ={total:0,available:0,currentValue:0,targetValue:0,currentPct:100,targetPct:60,orderAdjust:0,inventoryRange:'41% - 79%'};
        return {btc:btcZ,usdt:usdtZ,totalValue:0,isBalanced:false};
      }
      const btcBalance = balances.find(b => b.token === 'BTC') || {units:0,available_units:0};
      const usdtBalance = balances.find(b => b.token === 'USDT') || {};

      const btcTotal = parseFloat(btcBalance.units) || 0;
      const btcAvailable = parseFloat(btcBalance.available_units) || 0;
      const usdtTotal = parseFloat(usdtBalance.units) || 0;
      const usdtAvailable = parseFloat(usdtBalance.available_units) || 0;

      const btcValueUSDT = btcTotal * midPrice;
      const usdtValueUSDT = usdtTotal;
      const totalValueUSDT = btcValueUSDT + usdtValueUSDT;

      const btcCurrentPct = (btcValueUSDT / totalValueUSDT) * 100;
      const usdtCurrentPct = (usdtValueUSDT / totalValueUSDT) * 100;

      const btcTargetPct  = 40.0;
      const usdtTargetPct = 60.0;
      const btcTargetValue  = totalValueUSDT * 0.4;
      const usdtTargetValue = totalValueUSDT * 0.6;

      const btcOrderAdjust  = btcValueUSDT  > 0 ? (btcTargetValue  / btcValueUSDT)  * 100 : 0;
      const usdtOrderAdjust = usdtValueUSDT > 0 ? (usdtTargetValue / usdtValueUSDT) * 100 : 0;

      const inventoryMin = 21.0;
      const inventoryMax = 59.0;

      return {
        btc: {
          total: btcTotal,
          available: btcAvailable,
          currentValue: btcValueUSDT,
          targetValue: btcTargetValue,
          currentPct: btcCurrentPct,
          targetPct: btcTargetPct,
          orderAdjust: btcOrderAdjust,
          inventoryRange: `${inventoryMin}% - ${inventoryMax}%`
        },
        usdt: {
          total: usdtTotal,
          available: usdtAvailable,
          currentValue: usdtValueUSDT,
          targetValue: usdtTargetValue,
          currentPct: usdtCurrentPct,
          targetPct: usdtTargetPct,
          orderAdjust: usdtOrderAdjust,
          inventoryRange: `${100-inventoryMax}% - ${100-inventoryMin}%`
        },
        totalValue: totalValueUSDT,
        isBalanced: btcCurrentPct >= inventoryMin && btcCurrentPct <= inventoryMax
      };
    }


  function renderBotStatus(container, statusData, orderBookData, portfolioData, exchange, botId) {
      const logs = statusData?.data?.general_logs || [];
      const orders = parseBtcOrders(logs);

      const bestBid = orderBookData?.bids?.[0]?.price || 0;
      const bestAsk = orderBookData?.asks?.[0]?.price || 0;
      const midPrice = (parseFloat(bestBid) + parseFloat(bestAsk)) / 2;

      let balances = portfolioData?.cex_mm_binance?.kucoin || [];

      const assets = calculateBtcMetrics(balances, midPrice);

      const buyOrders = orders.filter(o => o.side === 'BUY').sort((a, b) => b.price - a.price).slice(0, 5);
      const sellOrders = orders.filter(o => o.side === 'SELL').sort((a, b) => a.price - b.price).slice(0, 5);

      const exchangeName = 'KuCoin';

      const balanceWarning = !assets.isBalanced ? `
        <div class="warning">
          ‚ö†Ô∏è Portfolio unbalanced! BTC: ${assets.btc.currentPct.toFixed(1)}% (target: 40%)
        </div>
      ` : '';

      const isRunning = window.testingBotRunning ?? false;
      const ex_key = 'testing';
      const uStats = getUptimeStats(ex_key);
      const uptimeBar = `<div class="uptime-bar ${isRunning?'good':'down'}">
        <span class="ub-status">${isRunning?'&#9679; Running':'&#9675; Stopped'}</span>
        ${uStats ? `<span class="ub-sep">|</span>
        <span><span class="ub-label">Uptime&nbsp;</span><span class="ub-val" id="uptime-inline-${ex_key}">${uStats.d}d ${uStats.h}h ${uStats.m}m</span></span>
        <span class="ub-sep">|</span>
        <span><span class="ub-label">Availability&nbsp;</span><span class="ub-val">${uStats.pct.toFixed(2)}%</span></span>` : ''}
      </div>`;

      const botIdDisplay = `
        <div style="margin-bottom: 15px; display: flex; justify-content: flex-end;">
          <span style="font-size: 13px; background: #f3f4f6; color: #374151; padding: 6px 12px; border-radius: 6px; font-family: monospace; font-weight: 500;">Bot ID: ${botId}</span>
        </div>
      `;

      const htmlContent = `
        ${uptimeBar}
        ${botIdDisplay}
        ${balanceWarning}

        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Markets</h3>
          <table>
            <thead>
              <tr>
                <th>Exchange</th>
                <th>Market</th>
                <th>Best Bid</th>
                <th>Best Ask</th>
                <th>Mid Price</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${exchangeName}</td>
                <td>BTC-USDT</td>
                <td>${bestBid.toFixed(2)}</td>
                <td>${bestAsk.toFixed(2)}</td>
                <td>${midPrice.toFixed(2)}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Assets</h3>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>BTC</th>
                  <th>USDT</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Total Balance</strong></td>
                  <td>${assets.btc.total.toFixed(6)}</td>
                  <td>${assets.usdt.total.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Available Balance</strong></td>
                  <td>${assets.btc.available.toFixed(6)}</td>
                  <td>${assets.usdt.available.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Current Value (USDT)</strong></td>
                  <td>${assets.btc.currentValue.toFixed(4)}</td>
                  <td>${assets.usdt.currentValue.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Target Value (USDT)</strong></td>
                  <td>${assets.btc.targetValue.toFixed(4)}</td>
                  <td>${assets.usdt.targetValue.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Current %</strong></td>
                  <td style="background:transparent;color:${assets.isBalanced?'#3fb950':'#f85149'};font-weight:700;">
                    ${assets.btc.currentPct.toFixed(1)}%
                  </td>
                  <td style="background:transparent;color:${assets.isBalanced?'#3fb950':'#f85149'};font-weight:700;">
                    ${assets.usdt.currentPct.toFixed(1)}%
                  </td>
                </tr>
                <tr>
                  <td><strong>Target %</strong></td>
                  <td>${assets.btc.targetPct.toFixed(1)}%</td>
                  <td>${assets.usdt.targetPct.toFixed(1)}%</td>
                </tr>
                <tr>
                  <td><strong>Inventory Range</strong></td>
                  <td>${assets.btc.inventoryRange}</td>
                  <td>${assets.usdt.inventoryRange}</td>
                </tr>
                <tr>
                  <td><strong>Order Adjust %</strong></td>
                  <td>${assets.btc.orderAdjust.toFixed(1)}%</td>
                  <td>${assets.usdt.orderAdjust.toFixed(1)}%</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
            Total Portfolio Value: $${assets.totalValue.toFixed(2)} USDT
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Orders (${buyOrders.length + sellOrders.length} recent)</h3>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Price</th>
                  <th>Spread</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                ${sellOrders.reverse().map(o => {
                  const spread = ((o.price - midPrice) / midPrice * 100).toFixed(2);
                  return `
                    <tr>
                      <td><span class="pill pill-sell">SELL</span></td>
                      <td>${o.price.toFixed(2)}</td>
                      <td>${spread}%</td>
                      <td>${o.amount.toFixed(6)}</td>
                    </tr>
                  `;
                }).join('')}
                ${buyOrders.map(o => {
                  const spread = ((midPrice - o.price) / midPrice * 100).toFixed(2);
                  return `
                    <tr>
                      <td><span class="pill pill-buy">BUY</span></td>
                      <td>${o.price.toFixed(2)}</td>
                      <td>${spread}%</td>
                      <td>${o.amount.toFixed(6)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      container.innerHTML = htmlContent;

      const metricsKey = 'testingBtcMetrics';
      window[metricsKey] = {
        btc_current_pct: assets.btc.currentPct,
        usdt_current_pct: assets.usdt.currentPct,
        btc_order_adjust: assets.btc.orderAdjust,
        usdt_order_adjust: assets.usdt.orderAdjust,
        is_balanced: assets.isBalanced,
        total_value_usdt: assets.totalValue,
        mid_price: midPrice,
        active_orders_count: buyOrders.length + sellOrders.length
      };
    }

  // ‚îÄ‚îÄ Data loaders ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchBotRunningStatus() {
  try {
    const response = await fetch('https://btc-metrics.eqtydao.workers.dev');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    window.testingBotRunning = data.binance?.bot_running === 1;
    trackDowntime('testing', window.testingBotRunning);
    updateStatusBadge();
  } catch(e) {
    console.error('Error fetching bot status:', e);
  }
}
function updateStatusBadge() {
  const el = document.getElementById('bot-status-badge');
  if (!el) return;
  const ok = window.testingBotRunning ?? false;
  el.className = `status-badge ${ok ? 'status-running' : 'status-stopped'}`;
  el.textContent = ok ? '‚óè Running' : '‚óã Stopped';
}
  async function loadBalance() {
  const el = document.getElementById('btc-balance');
  el.className = 'loading'; el.textContent = 'Loading KuCoin balance...';
  try {
    const data = await fetchPortfolioState(['cex_mm_binance'], ['kucoin']);
    const balances = data?.cex_mm_binance?.kucoin || [];
    renderBalanceTable('btc-balance', balances);
    window.btcPortfolioValue = balances.reduce((s,b) => s + parseFloat(b.value||0), 0);
  } catch(e) {
    el.className = 'error'; el.textContent = 'Error: ' + e.message;
  }
}
  async function loadBotStatus() {
  const container = document.getElementById('btc-bot-status');
  if (!container) return;
  container.innerHTML = '<div class="loading">Loading bot status...</div>';
  try {
    const botId = '843b015973491f3e50405a3e5993d3a2a30c207c';
    const [statusData, orderBookData, portfolioData] = await Promise.all([
      fetchBotStatus(botId),
      fetchOrderBook('kucoin', 'BTC-USDT'),
      fetchPortfolioState(['cex_mm_binance'], ['kucoin'])
    ]);
    await fetchBotRunningStatus();
    try {
      renderBotStatus(container, statusData, orderBookData, portfolioData, 'kucoin', botId);
    } catch(re) {
      container.innerHTML = `<div class="error">Render error: ${re.message}</div>`;
    }
  } catch(e) {
    container.innerHTML = `<div class="error">API error: ${e.message}</div>`;
  }
}
  async function loadTradeData(days = 1) {
  document.querySelectorAll('.days-btn').forEach(b => {
    b.classList.toggle('active', parseInt(b.dataset.days) === days);
  });
  const el = document.getElementById('btc-content');
  const pnlEl = document.getElementById('btc-pnl');
  el.className = 'loading'; el.textContent = 'Loading trades...';
  pnlEl.className = 'loading'; pnlEl.textContent = 'Loading P&L...';
  try {
    const data = await fetchWithAuth(`bot-orchestration/843b015973491f3e50405a3e5993d3a2a30c207c/history?days=${days}&verbose=false&timeout=8`);
    const trades = data?.response?.data?.data?.trades || [];
    renderTradesTable('btc-content', trades);
    const stats = computePnlStats(trades);
    window.lastBtcTradeStats = stats;
    const pv = window.btcPortfolioValue || 0;
    const mp = window.testingBtcMetrics?.mid_price || 0;
    renderPnlStats('btc-pnl', stats, pv, mp);
  } catch(e) {
    el.className = 'error'; el.textContent = 'Error: ' + e.message;
    pnlEl.className = 'error'; pnlEl.textContent = 'Error loading P&L';
  }
}

  function updateTimestamp() {
  const el = document.getElementById('last-update');
  if (el) el.textContent = 'Last updated: ' + new Date().toLocaleString();
}

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function init() {
  fetchBotRunningStatus(); // fire & forget
  loadBalance();
  loadBotStatus();
  loadTradeData(1);
  updateTimestamp();
}

  // ‚îÄ‚îÄ Heatmap core (from eqty) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function heatColor(t){
      if(t<=0)return'#161b22';
      const C=[[13,40,24],[26,71,49],[35,134,54],[63,185,80],[126,231,135]];
      const i=t*(C.length-1),lo=Math.floor(i),hi=Math.min(Math.ceil(i),C.length-1),f=i-lo;
      return`rgb(${Math.round(C[lo][0]+f*(C[hi][0]-C[lo][0]))},${Math.round(C[lo][1]+f*(C[hi][1]-C[lo][1]))},${Math.round(C[lo][2]+f*(C[hi][2]-C[lo][2]))})`;
    }
    function renderHeatmap(containerId, trades, days) {
  const el = document.getElementById(containerId);
  if (!el) return;
  if (!trades || !trades.length) {        // ‚Üê was: if (!trades.length)
    el.innerHTML = '<div class="loading">No trades in this period.</div>';
    return;
  }
      window._hmTrades=window._hmTrades||{};window._hmTrades[containerId]=trades;
      const dayMap={},dayLabels=[],matrix=[];
      for(let d=0;d<days;d++){
        const dt=new Date();dt.setHours(0,0,0,0);dt.setDate(dt.getDate()-(days-1-d));
        const key=`${dt.getFullYear()}-${dt.getMonth()}-${dt.getDate()}`;
        dayMap[key]=d;dayLabels.push(dt.toLocaleDateString([],{month:'short',day:'numeric'}));
        matrix.push(new Array(24).fill(0));
      }
      for(const t of trades){
        const tsRaw=t.trade_timestamp||t.timestamp||0,tsSec=tsRaw>1e10?tsRaw/1000:tsRaw;
        const d=new Date(tsSec*1000),key=`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`;
        const dayIdx=dayMap[key];if(dayIdx!==undefined)matrix[dayIdx][d.getHours()]++;
      }
      const maxVal=Math.max(1,...matrix.flat());
      const cw=days<=7?30:days<=14?26:22,ch=days<=7?28:days<=14?20:15;
      const dayKeys=Object.keys(dayMap).sort((a,b)=>dayMap[a]-dayMap[b]);
      let html=`<div class="hm-wrap"><div style="display:inline-block;">`;
      html+=`<div class="hm-row"><div class="hm-label"></div>`;
      for(let h=0;h<24;h++)html+=`<div style="width:${cw}px;text-align:center;font-size:9px;color:#6e7681;flex-shrink:0;">${h%3===0?h+'h':''}</div>`;
      html+=`</div>`;
      for(let d=0;d<days;d++){
        html+=`<div class="hm-row"><div class="hm-label">${dayLabels[d]}</div>`;
        for(let h=0;h<24;h++){
          const v=matrix[d][h],t2=v/maxVal,clickable=v>0;
          const onclick=clickable?` onclick="hmCellClick('${containerId}','${dayKeys[d]}',${h},this)"` :'';
          html+=`<div class="hm-cell${clickable?' has-trades':''}" style="width:${cw-2}px;height:${ch}px;margin-right:2px;background:${heatColor(t2)};"${onclick} title="${dayLabels[d]} ${h}:00\u202f\u2014\u202f${v} trade${v!==1?'s':''}"></div>`;
        }
        html+=`</div>`;
      }
      html+=`<div style="margin-left:48px;margin-top:10px;display:flex;align-items:center;gap:5px;"><span style="font-size:10px;color:#6e7681;">0</span>`;
      for(let i=0;i<=8;i++)html+=`<div style="width:14px;height:10px;border-radius:2px;background:${heatColor(i/8)};"></div>`;
      html+=`<span style="font-size:10px;color:#6e7681;">max (${maxVal}/hr) ¬∑ tap a cell to see trades</span></div></div></div>`;
      el.innerHTML=html;
    }
    function hmCellClick(cid,dayKey,hour,cellEl){
      document.querySelectorAll(`#${cid} .hm-cell.selected`).forEach(el=>el.classList.remove('selected'));
      const detailEl=document.getElementById(cid+'-detail');if(!detailEl)return;
      if(cellEl.dataset.open==='1'){cellEl.dataset.open='';detailEl.innerHTML='';return;}
      cellEl.classList.add('selected');cellEl.dataset.open='1';
      const trades=(window._hmTrades?.[cid]||[]).filter(t=>{
        const tsRaw=t.trade_timestamp||t.timestamp||0,tsSec=tsRaw>1e10?tsRaw/1000:tsRaw;
        const d=new Date(tsSec*1000);
        return`${d.getFullYear()}-${d.getMonth()}-${d.getDate()}`===dayKey&&d.getHours()===hour;
      }).sort((a,b)=>(a.trade_timestamp||0)-(b.trade_timestamp||0));
      if(!trades.length){detailEl.innerHTML='';return;}
      const dayLabel=new Date(trades[0].trade_timestamp>1e10?trades[0].trade_timestamp:trades[0].trade_timestamp*1000).toLocaleDateString([],{month:'short',day:'numeric'});
      let rows='';
      for(const t of trades){
        const tsRaw=t.trade_timestamp||0,tsSec=tsRaw>1e10?tsRaw/1000:tsRaw;
        const time=new Date(tsSec*1000).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const qty=parseFloat(String(t.quantity||'0').replace(/\.$/,''));
        const price=parseFloat(t.price||0),val=(qty*price).toFixed(4);
        const isBuy=(t.trade_type||'').toUpperCase()==='BUY';
        rows+=`<tr><td>${time}</td><td><span class="pill-${isBuy?'buy':'sell'}" style="padding:1px 7px;border-radius:999px;font-size:11px;font-weight:700;">${isBuy?'BUY':'SELL'}</span></td><td>${price}</td><td>${Math.round(qty).toLocaleString()}</td><td>$${val}</td></tr>`;
      }
      detailEl.innerHTML=`<div class="hm-detail"><div class="hm-detail-header"><span>&#128336; ${dayLabel} &nbsp;${hour}:00\u202f\u2014\u202f${(hour+1)%24}:00 &nbsp;&middot;&nbsp; ${trades.length} trade${trades.length>1?'s':''}</span><span class="hm-detail-close" onclick="document.getElementById('${cid}-detail').innerHTML='';document.querySelectorAll('#${cid} .hm-cell.selected').forEach(e=>{e.classList.remove('selected');e.dataset.open='';})">&#x2715;</span></div><div style="overflow-x:auto;"><table><thead><tr><th style="padding:5px 10px;text-align:left;font-size:11px;color:#6b7280;">Time</th><th style="padding:5px 10px;text-align:left;font-size:11px;color:#6b7280;">Side</th><th style="padding:5px 10px;text-align:left;font-size:11px;color:#6b7280;">Price</th><th style="padding:5px 10px;text-align:left;font-size:11px;color:#6b7280;">Qty</th><th style="padding:5px 10px;text-align:left;font-size:11px;color:#6b7280;">Value</th></tr></thead><tbody>${rows}</tbody></table></div></div>`;
    }
    
  async function loadActivityBtc(days) {
  if (days === undefined) days = 14;
  document.querySelectorAll('#activity-btc-days .days-btn').forEach(function(b) {
    b.classList.toggle('active', parseInt(b.dataset.days) === days);
  });
  var el = document.getElementById('activity-btc');
  var det = document.getElementById('activity-btc-detail');
  el.className = 'loading'; el.textContent = 'Loading heatmap...';
  if (det) det.innerHTML = '';
  try {
    var data = await fetchWithAuth(
      `bot-orchestration/843b015973491f3e50405a3e5993d3a2a30c207c/history?days=${days}&verbose=false&timeout=8`
    );
    // Try all known response shapes
    var t = data?.response?.data?.data?.trades
         || data?.data?.data?.trades
         || data?.data?.trades
         || data?.trades
         || [];
    console.log('[activity] trades found:', t.length, '| raw keys:', Object.keys(data || {}));
    renderHeatmap('activity-btc', t, days);
    if (typeof renderDailySummary === 'function') {
      renderDailySummary('daily-summary-btc', t, window.btcPortfolioValue || 0);
    } else {
      console.warn('renderDailySummary missing ‚Äì check your btc.html version');
    }
  } catch(e) {
    el.className = '';
    el.innerHTML = '<div class="error">Error: ' + e.message + '</div>';
    console.error('[loadActivityBtc]', e);
  }
}

  function showBtcTab(name) {
    document.querySelectorAll('.tab-content').forEach(function(el) { el.classList.remove('active'); });
    document.querySelectorAll('.tab').forEach(function(b) { b.classList.toggle('active', b.dataset.tab === name); });
    var panel = document.getElementById('tab-' + name);
    if (panel) panel.classList.add('active');
    if (name === 'activity') {
      var btn = document.querySelector('#activity-btc-days .days-btn.active');
      var days = btn ? parseInt(btn.dataset.days) : 14;
      var hm = document.getElementById('activity-btc');
      if (hm && !hm.querySelector('.hm-wrap')) loadActivityBtc(days);
    }
  }

  init(); // script at bottom of <body> ‚Äî DOM ready

</script>
</body>
</html>
