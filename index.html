<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Docker & Hummingbot Monitor</title>
  
  <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="manifest" href="site.webmanifest">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      background: white;
      padding: 20px 30px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .status-badge {
      display: inline-block;
      padding: 5px 15px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
    }

    .status-running {
      background: #10b981;
      color: white;
    }

    .status-stopped {
      background: #ef4444;
      color: white;
    }

    .status-unknown {
      background: #6b7280;
      color: white;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .card h2 {
      color: #333;
      font-size: 20px;
      margin-bottom: 15px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    .container-list {
      display: grid;
      gap: 15px;
    }

    .container-item {
      background: #f9fafb;
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .container-name {
      font-weight: 600;
      color: #333;
      font-size: 16px;
      margin-bottom: 5px;
    }

    .container-details {
      font-size: 14px;
      color: #6b7280;
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: #6b7280;
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 15px;
      border-radius: 8px;
    }

    .warning {
      background: #fffbeb;
      border: 1px solid #fcd34d;
      color: #92400e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .last-update {
      text-align: right;
      color: black;
      font-size: 14px;
      margin-top: 10px;
    }

    .refresh-info {
      background: #eff6ff;
      border: 1px solid #bfdbfe;
      color: #1e40af;
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    pre {
      background: #1f2937;
      color: #f9fafb;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      line-height: 1.5;
    }

    .nav-grid { display:grid; grid-template-columns:repeat(3,auto); grid-template-rows:auto auto; gap:6px 10px; justify-content:start; margin-top:10px; margin-bottom:5px; }
    .tab { background:#e5e7eb; border:none; border-radius:999px; padding:6px 16px; font-size:14px; cursor:pointer; color:#374151; transition:background 0.2s,color 0.2s; }
    .tab.active { background:#4f46e5; color:white; }
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Tables for trades */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #eff6ff;
      font-weight: 600;
    }

    tbody tr:nth-child(even) {
      background: #f9fafb;
    }

    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 600;
    }

    .pill-buy {
      background: #dcfce7;
      color: #15803d;
    }

    .pill-sell {
      background: #fee2e2;
      color: #b91c1c;
    }

    .pnl-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(128px,1fr));gap:10px;}
    .pnl-stat{position:relative;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:12px 10px;text-align:center;}
    .pnl-stat .label{font-size:11px;color:#9ca3af;text-transform:uppercase;font-weight:700;letter-spacing:.05em;margin-bottom:4px;}
    .pnl-stat .value{font-size:16px;font-weight:700;color:#111827;line-height:1.2;}
    .pnl-stat .sub{font-size:11px;color:#9ca3af;margin-top:3px;}
    .pnl-stat.positive{border-color:#86efac;background:#f0fdf4;} .pnl-stat.positive .value{color:#15803d;}
    .pnl-stat.negative{border-color:#fca5a5;background:#fef2f2;} .pnl-stat.negative .value{color:#dc2626;}
    .pnl-stat.neutral .value{color:#1e40af;} .pnl-stat.highlight{border-width:2px;}
    /* Tooltip */
    .stat-help{position:absolute;top:5px;right:7px;width:14px;height:14px;border-radius:50%;background:#d1d5db;color:#6b7280;font-size:9px;font-weight:700;line-height:14px;text-align:center;cursor:default;user-select:none;}
    .stat-help:hover .stat-tip{display:block;}
    .stat-tip{display:none;position:absolute;bottom:120%;right:0;background:#1f2937;color:#f9fafb;font-size:11px;font-weight:400;line-height:1.5;padding:7px 10px;border-radius:6px;width:190px;text-align:left;z-index:100;box-shadow:0 4px 14px rgba(0,0,0,0.35);white-space:normal;pointer-events:none;}
    [data-theme="dark"] .stat-help{background:#30363d;color:#8b949e;}
    [data-theme="dark"] .stat-tip{background:#e6edf3;color:#1f2937;}
    /* Days */
    .days-selector{display:inline-flex;gap:5px;float:right;}
    .days-btn{padding:3px 12px;border-radius:999px;border:1px solid #d1d5db;background:white;font-size:12px;font-weight:600;color:#374151;cursor:pointer;transition:all .15s;}
    .days-btn:hover{background:#f3f4f6;} .days-btn.active{background:#4f46e5;color:white;border-color:#4f46e5;}
    /* Uptime chips */
    .uptime-chip{display:inline-flex;align-items:center;gap:5px;background:#f3f4f6;border:1px solid #e5e7eb;border-radius:999px;padding:4px 12px;font-size:13px;color:#374151;}
    .uptime-chip.good{background:#f0fdf4;border-color:#86efac;color:#15803d;}
    .uptime-chip.warn{background:#fffbeb;border-color:#fcd34d;color:#92400e;}
    .uptime-chip.down{background:#fef2f2;border-color:#fca5a5;color:#dc2626;}
    .uptime-chip strong{font-weight:700;}
    /* Theme toggle */
    .theme-toggle-btn{background:none;border:1px solid #d1d5db;border-radius:999px;padding:5px 12px;font-size:15px;cursor:pointer;transition:all .2s;line-height:1;align-self:flex-start;margin-top:10px;}
    .theme-toggle-btn:hover{transform:scale(1.1);}
    /* DARK THEME */
    [data-theme="dark"] body{background:#0d1117;}
    [data-theme="dark"] header,[data-theme="dark"] .card{background:#161b22;box-shadow:0 4px 12px rgba(0,0,0,.5);}
    [data-theme="dark"] h1,[data-theme="dark"] .card h2,[data-theme="dark"] .container-name{color:#f0f6fc;}
    [data-theme="dark"] .card h2{border-bottom-color:#4f46e5;}
    [data-theme="dark"] .container-details,[data-theme="dark"] .last-update,[data-theme="dark"] .loading{color:#8b949e;}
    [data-theme="dark"] .container-item{background:#21262d;border-left-color:#4f46e5;}
    [data-theme="dark"] .error{background:#2d1515;border-color:#6d2626;color:#f87171;}
    [data-theme="dark"] .warning{background:#2d2208;border-color:#78350f;color:#fcd34d;}
    [data-theme="dark"] .refresh-info{background:#1c2947;border-color:#2d4a7a;color:#93c5fd;}
    [data-theme="dark"] .tab{background:#21262d;color:#8b949e;}
    [data-theme="dark"] .tab.active{background:#4f46e5;color:white;}
    [data-theme="dark"] th{background:#21262d;color:#e6edf3;}
    [data-theme="dark"] th,[data-theme="dark"] td{border-bottom-color:#30363d;color:#e6edf3;}
    [data-theme="dark"] tbody tr:nth-child(even){background:#1c2128;}
    [data-theme="dark"] tbody tr:nth-child(odd){background:#161b22;}
    [data-theme="dark"] tbody tr:hover{background:#272e38;}
    [data-theme="dark"] pre{background:#0d1117;border:1px solid #30363d;}
    [data-theme="dark"] .pill-buy{background:#0d2818;color:#3fb950;}
    [data-theme="dark"] .pill-sell{background:#2d1515;color:#f85149;}
    [data-theme="dark"] .pnl-stat{background:#21262d;border-color:#30363d;}
    [data-theme="dark"] .pnl-stat .label{color:#8b949e;} [data-theme="dark"] .pnl-stat .value{color:#e6edf3;} [data-theme="dark"] .pnl-stat .sub{color:#6e7681;}
    [data-theme="dark"] .pnl-stat.positive{background:#0d2818;border-color:#238636;} [data-theme="dark"] .pnl-stat.positive .value{color:#3fb950;}
    [data-theme="dark"] .pnl-stat.negative{background:#2d1515;border-color:#6d2626;} [data-theme="dark"] .pnl-stat.negative .value{color:#f85149;}
    [data-theme="dark"] .pnl-stat.neutral .value{color:#79c0ff;}
    [data-theme="dark"] .days-btn{background:#21262d;border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .days-btn:hover{background:#2d3748;} [data-theme="dark"] .days-btn.active{background:#4f46e5;color:white;border-color:#4f46e5;}
    [data-theme="dark"] .uptime-chip{background:#21262d;border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .uptime-chip.good{background:#0d2818;border-color:#238636;color:#3fb950;}
    [data-theme="dark"] .uptime-chip.warn{background:#2d2208;border-color:#78350f;color:#fcd34d;}
    [data-theme="dark"] .uptime-chip.down{background:#2d1515;border-color:#6d2626;color:#f85149;}
    [data-theme="dark"] .theme-toggle-btn{border-color:#30363d;color:#c9d1d9;}
    [data-theme="dark"] .theme-toggle-btn:hover{background:#21262d;}
    [data-theme="dark"] .status-unknown{background:#3d444d;}
  </style>
  <script>(function(){var t=localStorage.getItem("theme")||"dark";document.documentElement.setAttribute("data-theme",t);})();</script>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="page-title">üê≥ Docker & Hummingbot Monitor</h1>

      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div class="nav-grid">
          <button class="tab active" data-tab="docker" onclick="showTab('docker')">Docker</button>
          <button class="tab" data-tab="kucoin" onclick="showTab('kucoin')">KuCoin</button>
          <button class="tab" data-tab="gateio" onclick="showTab('gateio')">Gate.io</button>
          <span class="uptime-chip" id="chip-docker" style="visibility:hidden;font-size:12px;padding:3px 10px;"></span>
          <span class="uptime-chip" id="chip-kucoin" style="visibility:hidden;font-size:12px;padding:3px 10px;"></span>
          <span class="uptime-chip" id="chip-gateio" style="visibility:hidden;font-size:12px;padding:3px 10px;"></span>
        </div>
        <button id="theme-toggle" onclick="toggleTheme()" class="theme-toggle-btn" title="Toggle theme">&#9728;&#65039;</button>
      </div>
      <div id="docker-status" style="display:none;"></div>
    </header>

    <!-- DOCKER TAB -->
    <section id="tab-docker" class="tab-content active">
  <div class="card">
    <div class="refresh-info">
      Data loads fresh each time you click on tabs
    </div>
  </div>

  <div class="card">
    <h2>Docker Service Status</h2>
    <div id="docker-info" class="loading">Loading...</div>
  </div>

  <!-- NEW MQTT STATUS CARD -->
  <div class="card">
    <h2>MQTT Status</h2>
    <div id="mqtt-info" class="loading">Loading...</div>
  </div>

  <div class="card">
    <h2>Active Containers</h2>
    <div id="containers-info" class="loading">Loading...</div>
  </div>

  <div class="last-update" id="last-update"></div>
</section>

    <!-- KUCOIN TAB -->
    <section id="tab-kucoin" class="tab-content">
      <div class="card">
        <h2>KuCoin Balance</h2>
        <div id="kucoin-balance" class="loading">Loading KuCoin balance...</div>
      </div>

    <div class="card">
      <h2>Bot Status</h2>
      <div id="kucoin-bot-status" class="loading">Loading...</div>
    </div>


    <div class="card">
      <h2>P&L Summary
        <span class="days-selector" id="kucoin-days-selector">
          <button class="days-btn active" data-days="1" onclick="loadKucoinData(1)">1D</button>
          <button class="days-btn" data-days="7" onclick="loadKucoinData(7)">7D</button>
          <button class="days-btn" data-days="30" onclick="loadKucoinData(30)">30D</button>
        </span>
      </h2>
      <div id="kucoin-pnl" class="loading">Loading P&L...</div>
    </div>

    <div class="card">
      <h2>KuCoin Trades</h2>
      <div id="kucoin-content" class="loading">Loading KuCoin data...</div>
    </div>
    </section>


    <!-- GATE.IO TAB -->
    <section id="tab-gateio" class="tab-content">
      <div class="card">
        <h2>Gate.io Balance</h2>
        <div id="gateio-balance" class="loading">Loading Gate.io balance...</div>
      </div>

      <div class="card">
        <h2>Bot Status</h2>
        <div id="gateio-bot-status" class="loading">Loading...</div>
      </div>


      <div class="card">
        <h2>P&L Summary
          <span class="days-selector" id="gateio-days-selector">
            <button class="days-btn active" data-days="1" onclick="loadGateioData(1)">1D</button>
            <button class="days-btn" data-days="7" onclick="loadGateioData(7)">7D</button>
            <button class="days-btn" data-days="30" onclick="loadGateioData(30)">30D</button>
          </span>
        </h2>
        <div id="gateio-pnl" class="loading">Loading P&L...</div>
      </div>

      <div class="card">
        <h2>Gate.io Trades</h2>
        <div id="gateio-content" class="loading">Loading Gate.io data...</div>
      </div>
  </section>

  </div>

  <script>
    // Vercel proxy base (server-side credentials)
    const API_BASE = 'https://docker-proxy-eta.vercel.app/api/docker';
    const REFRESH_INTERVAL = 120000;

    // Generic fetch via proxy
    async function fetchWithAuth(endpoint) {
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      return await response.json();
    }

    // -------- Docker tab logic --------
    async function checkDockerStatus() {
      const dockerInfo = document.getElementById('docker-info');
      try {
        const data = await fetchWithAuth('/docker/running');
        const isRunning =
          data === true || data === 'true' ||
          (typeof data === 'object' && (data.running || data.status === 'running'));
        const dc=document.getElementById('chip-docker'),kc=document.getElementById('chip-kucoin'),gc=document.getElementById('chip-gateio');
        if(dc){dc.className=`uptime-chip ${isRunning?'good':'down'}`;dc.innerHTML=`${isRunning?'&#9679;':'&#9675;'} <strong>${isRunning?'Running':'Stopped'}</strong>`;dc.style.visibility='visible';}
        if(kc)kc.style.visibility='hidden';
        if(gc)gc.style.visibility='hidden';
        dockerInfo.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
      } catch (error) {
        const dc=document.getElementById('chip-docker');
        if(dc){dc.className='uptime-chip warn';dc.innerHTML='&#9888; <strong>Error</strong>';dc.style.visibility='visible';}
        dockerInfo.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    async function fetchActiveContainers() {
      try {
        const data = await fetchWithAuth('/docker/active-containers');
        const containersDiv = document.getElementById('containers-info');

        if (Array.isArray(data) && data.length > 0) {
          containersDiv.innerHTML = `
            <div class="container-list">
              ${data.map(container => `
                <div class="container-item">
                  <div class="container-name">${container.name || container.Names || 'Unnamed Container'}</div>
                  <div class="container-details">
                    ${container.id || container.Id ? `ID: ${(container.id || container.Id).substring(0, 12)}` : ''}
                    ${container.status || container.Status ? ` | Status: ${container.status || container.Status}` : ''}
                    ${container.image || container.Image ? ` | Image: ${container.image || container.Image}` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 15px; padding: 10px; background: #f0fdf4; border-radius: 6px; color: #15803d; font-size: 14px;">
              Total active containers: ${data.length}
            </div>
          `;
        } else if (Array.isArray(data) && data.length === 0) {
          containersDiv.innerHTML = '<div style="color: #6b7280; text-align: center;">No active containers found</div>';
        } else {
          containersDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
      } catch (error) {
        document.getElementById('containers-info').innerHTML =
          `<div class="error">Error: ${error.message}</div>`;
      }
    }
async function fetchMQTTStatus() {
  try {
    const data = await fetchWithAuth('/bot-orchestration/mqtt');
    const mqttDiv = document.getElementById('mqtt-info');

    // Extract data
    const mqttData = data?.data || data;
    const connected = mqttData.mqtt_connected === true || mqttData.client_state === 'connected';
    const activeBots = mqttData.active_bots || [];
    const discoveredBots = mqttData.discovered_bots || [];
    const brokerHost = mqttData.broker_host || '-';
    const brokerPort = mqttData.broker_port || '-';

    const statusBadge = connected
      ? '<span class="status-badge status-running">‚úì Connected</span>'
      : '<span class="status-badge status-stopped">‚úó Disconnected</span>';

    mqttDiv.innerHTML = `
      <div style="margin-bottom: 15px;">
        <strong>Connection Status:</strong> ${statusBadge}
      </div>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
        <div>
          <strong>Broker:</strong> ${brokerHost}:${brokerPort}
        </div>
        <div>
          <strong>Active Bots:</strong> ${activeBots.length}
        </div>
        <div>
          <strong>Discovered Bots:</strong> ${discoveredBots.length}
        </div>
      </div>
      ${activeBots.length > 0 ? `
        <div style="background: #f0fdf4; padding: 10px; border-radius: 6px; margin-top: 10px;">
          <strong style="color: #15803d;">Active Bots:</strong>
          <div style="margin-top: 5px; color: #166534; font-size: 13px; font-family: monospace;">
            ${activeBots.map(bot => `<div>‚Ä¢ ${bot}</div>`).join('')}
          </div>
        </div>
      ` : ''}
      ${discoveredBots.length > 0 ? `
        <div style="background: #eff6ff; padding: 10px; border-radius: 6px; margin-top: 10px;">
          <strong style="color: #1e40af;">Discovered Bots:</strong>
          <div style="margin-top: 5px; color: #1e3a8a; font-size: 13px; font-family: monospace;">
            ${discoveredBots.map(bot => `<div>‚Ä¢ ${bot}</div>`).join('')}
          </div>
        </div>
      ` : ''}
    `;

  } catch (error) {
    document.getElementById('mqtt-info').innerHTML =
      `<div class="error">Error: ${error.message}</div>`;
  }
}


    function updateTimestamp() {
      const now = new Date();
      document.getElementById('last-update').textContent =
        `Last updated: ${now.toLocaleString()}`;
    }

    async function refreshAll() {
      await Promise.all([
        checkDockerStatus(),
        fetchActiveContainers(),
	fetchMQTTStatus()         // NEW
      ]);
      updateTimestamp();
    }

    // -------- Tabs --------
    function showTab(tabName) {
  document.querySelectorAll('.tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.tab === tabName);
  });

  document.querySelectorAll('.tab-content').forEach(sec => {
    sec.classList.toggle('active', sec.id === `tab-${tabName}`);
  });

  // Update page header and status badge
  const pageTitle = document.querySelector('h1');
  const statusDiv = document.getElementById('docker-status');
  
  if (tabName === 'docker') {
    pageTitle.textContent = 'üê≥ Docker & Hummingbot Monitor';
    refreshAll();
  } else if (tabName === 'kucoin') {
    pageTitle.textContent = 'üíπ KuCoin - EQTY MM stats';
    if (statusDiv) statusDiv.style.display = 'none';
    renderUptimeBar('kucoin', window.kucoinBotRunning ?? false);
    startUptimeTick('kucoin');
    loadKucoinBalance(); loadKucoinBotStatus(); loadKucoinData();
    fetchBotRunningStatus();
  } else if (tabName === 'gateio') {
    pageTitle.textContent = 'üè¶ Gate.io - EQTY MM stats';
    if (statusDiv) statusDiv.style.display = 'none';
    renderUptimeBar('gateio', window.gateioBotRunning ?? false);
    startUptimeTick('gateio');
    loadGateioBalance(); loadGateioBotStatus(); loadGateioData();
    fetchBotRunningStatus();
  }
} 
    // -------- Helper: render trades table --------
    function renderTradesTable(containerId, trades) {
  const container = document.getElementById(containerId);

  if (!Array.isArray(trades) || trades.length === 0) {
    container.innerHTML = '<div style="color:#6b7280; text-align:center;">No trades found</div>';
    return;
  }

  const rows = trades.map(t => {
    const dt = new Date(t.trade_timestamp || t.timestamp || Date.now());
    const side = (t.trade_type || t.side || '').toUpperCase();
    const sideClass = side === 'BUY' ? 'pill pill-buy' : 'pill pill-sell';

    const rawQty = t.quantity ?? t.amount ?? '';
    const cleanQty = typeof rawQty === 'string'
      ? rawQty.replace(/\.$/, '')
      : rawQty;

    return `
      <tr>
        <td>${dt.toLocaleString()}</td>
        <td>${t.symbol || '-'}</td>
        <td><span class="${sideClass}">${side || '-'}</span></td>
        <td>${t.price ?? '-'}</td>
        <td>${cleanQty || '-'}</td>
        <td>${t.market || t.exchange || '-'}</td>
      </tr>
    `;
  }).join('');

  container.innerHTML = `
    <div style="overflow-x:auto; max-height: 600px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px;">
      <table>
        <thead style="position: sticky; top: 0; background: #eff6ff; z-index: 10;">
          <tr>
            <th>Time</th>
            <th>Pair</th>
            <th>Side</th>
            <th>Price</th>
            <th>Quantity</th>
            <th>Market</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
    <div style="margin-top: 10px; text-align: center; color: #6b7280; font-size: 13px;">
      Showing ${trades.length} trade${trades.length !== 1 ? 's' : ''}
    </div>
  `;
}


    function renderBalanceTable(containerId, balances) {
  const el = document.getElementById(containerId);

  if (!Array.isArray(balances) || balances.length === 0) {
    el.innerHTML = '<div style="color:#6b7280; text-align:center;">No balance data</div>';
    return;
  }

  const rows = balances.map(b => `
    <tr>
      <td>${b.token || '-'}</td>
      <td>${b.units ?? '-'}</td>
      <td>${b.available_units ?? '-'}</td>
      <td>${b.price ?? '-'}</td>
      <td>${b.value ?? '-'}</td>
    </tr>
  `).join('');

  el.innerHTML = `
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Token</th>
            <th>Total</th>
            <th>Available</th>
            <th>Price</th>
            <th>Value</th>
          </tr>
        </thead>
        <tbody>
          ${rows}
        </tbody>
      </table>
    </div>
  `;
}


// ==================== BOT STATUS FUNCTIONS ====================

// Fetch bot running status from metrics API
async function fetchBotRunningStatus() {
  try {
    const response = await fetch('https://docker-proxy-eta.vercel.app/api/metrics');
    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    const data = await response.json();
    
    window.kucoinBotRunning = data.kucoin?.bot_running === 1;
    window.gateioBotRunning = data.gateio?.bot_running === 1;
    trackDowntime('kucoin', window.kucoinBotRunning);
    trackDowntime('gateio', window.gateioBotRunning);
    const _at = document.querySelector('.tab.active')?.dataset.tab;
    if (_at === 'kucoin') { renderUptimeBar('kucoin', window.kucoinBotRunning); startUptimeTick('kucoin'); }
    else if (_at === 'gateio') { renderUptimeBar('gateio', window.gateioBotRunning); startUptimeTick('gateio'); }
    
  } catch (error) {
    console.error('Error fetching bot status:', error);
    const statusDiv = document.getElementById('docker-status');
    if (statusDiv) {
      statusDiv.innerHTML = '<span class="status-badge status-unknown">‚ö† Error</span>';
    }
  }
}

// KuCoin Bot Status
async function loadKucoinBotStatus() {
  const container = document.getElementById('kucoin-bot-status');
  if (!container) return;

  container.innerHTML = '<div class="loading">Loading bot status...</div>';

  try {
    const botId = 'ea5d7b611fd1da6ad5bffd559bac3c0ed6ed11d0';
    const [statusData, orderBookData, portfolioData] = await Promise.all([
      fetchBotStatus(botId),
      fetchOrderBook('kucoin', 'EQTY-USDT'),
      fetchPortfolioState(['cex_mm_kucoin'], ['kucoin'])
    ]);
    
    // Fetch bot running status from metrics
    await fetchBotRunningStatus();
  
    renderBotStatus(container, statusData, orderBookData, portfolioData, 'kucoin', botId);
  } catch (error) {
    container.innerHTML = `<div class="error">Error loading bot status: ${error.message}</div>`;
  } 
}

// Gate.io Bot Status
async function loadGateioBotStatus() {
  const container = document.getElementById('gateio-bot-status');
  if (!container) return;
    
  container.innerHTML = '<div class="loading">Loading bot status...</div>';
    
  try {
    const botId = 'da6132e324292f6f7b914b58333808506f741db0';
    const [statusData, orderBookData, portfolioData] = await Promise.all([
      fetchBotStatus(botId),
      fetchOrderBook('gate_io', 'EQTY-USDT'),
      fetchPortfolioState(['cex_mm_gate'], ['gate_io'])
    ]);
    
    // Fetch bot running status from metrics
    await fetchBotRunningStatus();

    renderBotStatus(container, statusData, orderBookData, portfolioData, 'gate_io', botId);
  } catch (error) {
    container.innerHTML = `<div class="error">Error loading bot status: ${error.message}</div>`;
  }
}

    async function fetchBotStatus(botName) {
      const endpoint = `/bot-orchestration/${botName}/status`;
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

    async function fetchOrderBook(connector, pair) {
      const endpoint = '/market-data/order-book';
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          connector_name: connector,
          trading_pair: pair
        })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

    async function fetchPortfolioState(accountNames, connectorNames) {
      const endpoint = '/portfolio/state';
      const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          account_names: accountNames,
          connector_names: connectorNames,
          skip_gateway: false,
          refresh: true
        })
      });
      if (!response.ok) throw new Error(`HTTP ${response.status}`);
      return await response.json();
    }

    function parseOrdersFromLogs(logs) {
      const orderPattern = /Created (LIMIT_MAKER|LIMIT) (BUY|SELL) order (\S+) for ([\d.]+) EQTY-USDT at ([\d.]+)/;
      const uniqueOrders = new Map();

      for (let i = logs.length - 1; i >= 0; i--) {
        const log = logs[i];
        const msg = log.msg || '';
        const match = msg.match(orderPattern);

        if (match) {
          const [, orderType, side, orderId, amount, price] = match;
          const priceLevel = parseFloat(price).toFixed(6);
          const key = `${side}_${priceLevel}`;

          if (!uniqueOrders.has(key)) {
            uniqueOrders.set(key, {
              orderType,
              side,
              orderId,
              amount: parseFloat(amount),
              price: parseFloat(price),
              timestamp: log.timestamp
            });
          }
        }
      }

      return Array.from(uniqueOrders.values());
    }

    function calculateAssetMetrics(balances, midPrice) {
      const eqtyBalance = balances.find(b => b.token === 'EQTY') || {};
      const usdtBalance = balances.find(b => b.token === 'USDT') || {};

      const eqtyTotal = parseFloat(eqtyBalance.units) || 0;
      const eqtyAvailable = parseFloat(eqtyBalance.available_units) || 0;
      const usdtTotal = parseFloat(usdtBalance.units) || 0;
      const usdtAvailable = parseFloat(usdtBalance.available_units) || 0;

      const eqtyValueUSDT = eqtyTotal * midPrice;
      const usdtValueUSDT = usdtTotal;
      const totalValueUSDT = eqtyValueUSDT + usdtValueUSDT;

      const eqtyCurrentPct = (eqtyValueUSDT / totalValueUSDT) * 100;
      const usdtCurrentPct = (usdtValueUSDT / totalValueUSDT) * 100;

      const targetPct = 50.0;
      const targetValueUSDT = totalValueUSDT / 2;

      const eqtyOrderAdjust = (targetValueUSDT / eqtyValueUSDT) * 100;
      const usdtOrderAdjust = (targetValueUSDT / usdtValueUSDT) * 100;

      const inventoryMin = 31.0;
      const inventoryMax = 69.0;

      return {
        eqty: {
          total: eqtyTotal,
          available: eqtyAvailable,
          currentValue: eqtyValueUSDT,
          targetValue: targetValueUSDT,
          currentPct: eqtyCurrentPct,
          targetPct: targetPct,
          orderAdjust: eqtyOrderAdjust,
          inventoryRange: `${inventoryMin}% - ${inventoryMax}%`
        },
        usdt: {
          total: usdtTotal,
          available: usdtAvailable,
          currentValue: usdtValueUSDT,
          targetValue: targetValueUSDT,
          currentPct: usdtCurrentPct,
          targetPct: targetPct,
          orderAdjust: usdtOrderAdjust,
          inventoryRange: `${inventoryMin}% - ${inventoryMax}%`
        },
        totalValue: totalValueUSDT,
        isBalanced: eqtyCurrentPct >= inventoryMin && eqtyCurrentPct <= inventoryMax
      };
    }

    function renderBotStatus(container, statusData, orderBookData, portfolioData, exchange, botId) {
      const logs = statusData?.data?.general_logs || [];
      const orders = parseOrdersFromLogs(logs);

      const bestBid = orderBookData?.bids?.[0]?.price || 0;
      const bestAsk = orderBookData?.asks?.[0]?.price || 0;
      const midPrice = (parseFloat(bestBid) + parseFloat(bestAsk)) / 2;

      let balances = [];
      if (exchange === 'kucoin') {
        balances = portfolioData?.cex_mm_kucoin?.kucoin || [];
      } else if (exchange === 'gate_io') {
        balances = portfolioData?.cex_mm_gate?.gate_io || [];
      }

      const assets = calculateAssetMetrics(balances, midPrice);

      const buyOrders = orders.filter(o => o.side === 'BUY').sort((a, b) => b.price - a.price).slice(0, 5);
      const sellOrders = orders.filter(o => o.side === 'SELL').sort((a, b) => a.price - b.price).slice(0, 5);

      const exchangeName = exchange === 'kucoin' ? 'kucoin' : 'gate.io';

      const balanceWarning = !assets.isBalanced ? `
        <div class="warning">
          ‚ö†Ô∏è Portfolio unbalanced! EQTY: ${assets.eqty.currentPct.toFixed(1)}% (target: 50%)
        </div>
      ` : '';

      const botIdDisplay = `
        <div style="margin-bottom: 15px; display: flex; justify-content: flex-end;">
          <span style="font-size: 13px; background: #f3f4f6; color: #374151; padding: 6px 12px; border-radius: 6px; font-family: monospace; font-weight: 500;">Bot ID: ${botId}</span>
        </div>
      `;

      const htmlContent = `
        ${botIdDisplay}
        ${balanceWarning}

        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Markets</h3>
          <table>
            <thead>
              <tr>
                <th>Exchange</th>
                <th>Market</th>
                <th>Best Bid</th>
                <th>Best Ask</th>
                <th>Mid Price</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>${exchangeName}</td>
                <td>EQTY-USDT</td>
                <td>${bestBid.toFixed(6)}</td>
                <td>${bestAsk.toFixed(6)}</td>
                <td>${midPrice.toFixed(7)}</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Assets</h3>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th></th>
                  <th>EQTY</th>
                  <th>USDT</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><strong>Total Balance</strong></td>
                  <td>${assets.eqty.total.toFixed(0)}</td>
                  <td>${assets.usdt.total.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Available Balance</strong></td>
                  <td>${assets.eqty.available.toFixed(0)}</td>
                  <td>${assets.usdt.available.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Current Value (USDT)</strong></td>
                  <td>${assets.eqty.currentValue.toFixed(4)}</td>
                  <td>${assets.usdt.currentValue.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Target Value (USDT)</strong></td>
                  <td>${assets.eqty.targetValue.toFixed(4)}</td>
                  <td>${assets.usdt.targetValue.toFixed(4)}</td>
                </tr>
                <tr>
                  <td><strong>Current %</strong></td>
                  <td style="background:transparent;color:${assets.isBalanced?'#3fb950':'#f85149'};font-weight:700;">
                    ${assets.eqty.currentPct.toFixed(1)}%
                  </td>
                  <td style="background:transparent;color:${assets.isBalanced?'#3fb950':'#f85149'};font-weight:700;">
                    ${assets.usdt.currentPct.toFixed(1)}%
                  </td>
                </tr>
                <tr>
                  <td><strong>Target %</strong></td>
                  <td>${assets.eqty.targetPct.toFixed(1)}%</td>
                  <td>${assets.usdt.targetPct.toFixed(1)}%</td>
                </tr>
                <tr>
                  <td><strong>Inventory Range</strong></td>
                  <td>${assets.eqty.inventoryRange}</td>
                  <td>${assets.usdt.inventoryRange}</td>
                </tr>
                <tr>
                  <td><strong>Order Adjust %</strong></td>
                  <td>${assets.eqty.orderAdjust.toFixed(1)}%</td>
                  <td>${assets.usdt.orderAdjust.toFixed(1)}%</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div style="margin-top: 10px; font-size: 13px; color: #6b7280;">
            Total Portfolio Value: $${assets.totalValue.toFixed(2)} USDT
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <h3 style="margin-bottom: 10px;">Orders (${buyOrders.length + sellOrders.length} recent)</h3>
          <div style="overflow-x: auto;">
            <table>
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Price</th>
                  <th>Spread</th>
                  <th>Amount</th>
                </tr>
              </thead>
              <tbody>
                ${sellOrders.reverse().map(o => {
                  const spread = ((o.price - midPrice) / midPrice * 100).toFixed(2);
                  return `
                    <tr>
                      <td><span class="pill pill-sell">SELL</span></td>
                      <td>${o.price.toFixed(6)}</td>
                      <td>${spread}%</td>
                      <td>${o.amount.toFixed(0)}</td>
                    </tr>
                  `;
                }).join('')}
                ${buyOrders.map(o => {
                  const spread = ((midPrice - o.price) / midPrice * 100).toFixed(2);
                  return `
                    <tr>
                      <td><span class="pill pill-buy">BUY</span></td>
                      <td>${o.price.toFixed(6)}</td>
                      <td>${spread}%</td>
                      <td>${o.amount.toFixed(0)}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

      container.innerHTML = htmlContent;

      const metricsKey = exchange === 'kucoin' ? 'eqtyBotMetrics' : 'gateioMetrics';
      window[metricsKey] = {
        eqty_current_pct: assets.eqty.currentPct,
        usdt_current_pct: assets.usdt.currentPct,
        eqty_order_adjust: assets.eqty.orderAdjust,
        usdt_order_adjust: assets.usdt.orderAdjust,
        is_balanced: assets.isBalanced,
        total_value_usdt: assets.totalValue,
        mid_price: midPrice,
        active_orders_count: buyOrders.length + sellOrders.length
      };
    }


    async function loadKucoinBalance() {
  const el = document.getElementById('kucoin-balance');
  el.classList.remove('error');
  el.classList.add('loading');
  el.textContent = 'Loading KuCoin balance...';

  try {
    const url = `${API_BASE}?endpoint=${encodeURIComponent('/portfolio/state')}`;

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        account_names: ['cex_mm_kucoin'],
        connector_names: ['kucoin'],
        skip_gateway: false,
        refresh: true
      })
    });
    
    if (!response.ok) {
      throw new Error(`HTTP ${response.status}: ${response.statusText}`);
    } 

    const data = await response.json();

    const balances = data?.cex_mm_kucoin?.kucoin || [];
    
    // Calculate total value
    const totalValue = balances.reduce((sum, b) => sum + (b.value || 0), 0);
    
    // Update header with stats
    const balanceCard = el.closest('.card');
    const header = balanceCard.querySelector('h2');
    const uid = '253168596'; // Replace with your actual KuCoin UID
    header.innerHTML = `KuCoin Balance <span style="float: right; display: flex; gap: 10px;">
      <span style="font-size: 14px; background: #eff6ff; color: #1e40af; padding: 4px 12px; border-radius: 6px; font-weight: 500;">UID: ${uid}</span>
      <span style="font-size: 14px; background: #f0fdf4; color: #15803d; padding: 4px 12px; border-radius: 6px; font-weight: 500;">Total: $${totalValue.toFixed(2)}</span>
    </span>`;

    window.kucoinPortfolioValue = totalValue;
    renderBalanceTable('kucoin-balance', balances);
  } catch (error) {
    el.classList.remove('loading');
    el.innerHTML = `<div class="error">Error loading KuCoin balance: ${error.message}</div>`;
  }
}

async function loadGateioBalance() {
  const el = document.getElementById('gateio-balance');
  el.classList.remove('error');
  el.classList.add('loading');
  el.textContent = 'Loading Gate.io balance...';

  try {
    const endpoint = '/portfolio/state';
    const url = `${API_BASE}?endpoint=${encodeURIComponent(endpoint)}`;
    
    const body = {
      account_names: ['cex_mm_gate'],
      connector_names: ['gate_io'],
      skip_gateway: false,
      refresh: true
    };

    const response = await fetch(url, {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(body)
    });

    if (!response.ok) {
      const text = await response.text();
      throw new Error(`HTTP ${response.status}: ${text || response.statusText}`);
    }

    const data = await response.json();
    
    // LOG THE FULL DATA (remove after checking)
    //console.log('üîç Full Gate.io API Response:', JSON.stringify(data, null, 2));
    //console.log('üîç Full Gate.io Data Object:', data);

    // Expecting: { "cex_mm_gate": { "gate_io": [ {token, units, ...}, ... ] } }
    const balances = data?.cex_mm_gate?.gate_io || [];
    
    // Calculate total value
    const totalValue = balances.reduce((sum, b) => sum + (b.value || 0), 0);
    
    // Update header with stats
    const balanceCard = el.closest('.card');
    const header = balanceCard.querySelector('h2');
    const uid = '47462332'; // Replace with your actual Gate.io UID
    header.innerHTML = `Gate.io Balance <span style="float: right; display: flex; gap: 10px;">
      <span style="font-size: 14px; background: #eff6ff; color: #1e40af; padding: 4px 12px; border-radius: 6px; font-weight: 500;">UID: ${uid}</span>
      <span style="font-size: 14px; background: #f0fdf4; color: #15803d; padding: 4px 12px; border-radius: 6px; font-weight: 500;">Total: $${totalValue.toFixed(2)}</span>
    </span>`;

    window.gateioPortfolioValue = totalValue;
    renderBalanceTable('gateio-balance', balances);
  } catch (error) {
    el.classList.remove('loading');
    el.innerHTML = `<div class="error">Error loading Gate.io balance: ${error.message}</div>`;
  }
}


    const UPTIME_CONFIG={kucoin:{start:new Date('2026-02-01T00:00:00')},gateio:{start:null}};
    function _dk(ex){return`uptime_down_s_${ex}`;}
    function trackDowntime(ex,ok){if(!ok){const k=_dk(ex);localStorage.setItem(k,parseInt(localStorage.getItem(k)||'0')+Math.round(REFRESH_INTERVAL/1000));}}
    function getUptimeStats(ex){
      const cfg=UPTIME_CONFIG[ex];if(!cfg?.start)return null;
      const tot=(Date.now()-cfg.start.getTime())/1000,dn=parseInt(localStorage.getItem(_dk(ex))||'0'),up=Math.max(0,tot-dn);
      return{d:Math.floor(up/86400),h:Math.floor((up%86400)/3600),m:Math.floor((up%3600)/60),pct:(up/tot)*100};
    }
    function renderUptimeBar(ex,running){
      const s=getUptimeStats(ex),rc=running?'good':'down',ri=running?'&#9679;':'&#9675;',rl=running?'Running':'Stopped';
      const dc=document.getElementById('chip-docker'),kc=document.getElementById('chip-kucoin'),gc=document.getElementById('chip-gateio');
      if(dc){dc.className=`uptime-chip ${rc}`;dc.innerHTML=`${ri} <strong>${rl}</strong>`;dc.style.visibility='visible';}
      if(!s){if(kc)kc.style.visibility='hidden';if(gc){gc.className='uptime-chip';gc.innerHTML=`&#128338; <strong>Not started</strong>`;gc.style.visibility='visible';}return;}
      const pc=s.pct>=95?'good':s.pct>=90?'warn':'down';
      if(kc){kc.className='uptime-chip';kc.innerHTML=`&#9201; <strong id="uptime-timer-${ex}">${s.d}d ${s.h}h ${s.m}m</strong>`;kc.style.visibility='visible';}
      if(gc){gc.className=`uptime-chip ${pc}`;gc.innerHTML=`&#128200; <strong>${s.pct.toFixed(2)}%</strong>&nbsp;uptime`;gc.style.visibility='visible';}
    }
    function startUptimeTick(ex){
      if(window[`_tick_${ex}`])return;
      window[`_tick_${ex}`]=setInterval(()=>{const s=getUptimeStats(ex),el=document.getElementById(`uptime-timer-${ex}`);if(s&&el)el.textContent=`${s.d}d ${s.h}h ${s.m}m`;},60000);
    }
    function toggleTheme(){
      const h=document.documentElement,n=(h.getAttribute('data-theme')||'dark')==='dark'?'light':'dark';
      h.setAttribute('data-theme',n);localStorage.setItem('theme',n);
      const b=document.getElementById('theme-toggle');if(b)b.textContent=n==='dark'?'\u2600\uFE0F':'\uD83C\uDF19';
    }
    document.addEventListener('DOMContentLoaded',()=>{
      const s=localStorage.getItem('theme')||'dark';document.documentElement.setAttribute('data-theme',s);
      const b=document.getElementById('theme-toggle');if(b)b.textContent=s==='dark'?'\u2600\uFE0F':'\uD83C\uDF19';
    });
    function computePnlStats(trades){
      let bv=0,bq=0,bc=0,sv=0,sq=0,sc=0,fees=0;
      for(const t of trades){const p=parseFloat(t.price)||0,q=parseFloat(String(t.quantity??'').replace(/\.$/,''))||0,f=parseFloat(t.raw_json?.trade_fee?.percent??'0.003'),n=p*q;fees+=n*f;if((t.trade_type||'').toUpperCase()==='BUY'){bv+=n;bq+=q;bc++;}else{sv+=n;sq+=q;sc++;}}
      return{buyVolume:bv,buyQty:bq,buyCount:bc,sellVolume:sv,sellQty:sq,sellCount:sc,totalFees:fees,tradePnl:sv-bv,netPnl:sv-bv-fees,totalVolume:bv+sv,totalEqtyVol:bq+sq,avgBuyPrice:bq>0?bv/bq:0,avgSellPrice:sq>0?sv/sq:0,netEqtyChange:bq-sq,tradeCount:trades.length};
    }
    function renderPnlStats(id,s,pv,mp){
      const el=document.getElementById(id);if(!el)return;
      const ret=pv>0?(s.netPnl/pv)*100:null,tpnl=mp>0?s.netPnl+(s.netEqtyChange*mp):null;
      const fmt=(n,d=4)=>n===null?'\u2014':(n>=0?`+$${Math.abs(n).toFixed(d)}`:`-$${Math.abs(n).toFixed(d)}`);
      const fp=n=>n===null?'\u2014':`${n>=0?'+':''}${n.toFixed(3)}%`;
      const cls=n=>n===null?'neutral':n>=0?'positive':'negative';
      const ic=s.netEqtyChange>0?'positive':s.netEqtyChange<0?'negative':'neutral';
      const tip=t=>`<span class="stat-help">?<span class="stat-tip">${t}</span></span>`;
      el.innerHTML=`<div class="pnl-grid">
        <div class="pnl-stat neutral">${tip('Number of executed trades in the period (B\u202f=\u202fbuys, S\u202f=\u202fsells)')}<div class="label">Trades</div><div class="value">${s.tradeCount}</div><div class="sub">${s.buyCount}B / ${s.sellCount}S</div></div>
        <div class="pnl-stat neutral">${tip('Total notional value traded in USDT (buys + sells combined)')}<div class="label">Volume</div><div class="value">$${s.totalVolume.toFixed(2)}</div><div class="sub">notional USDT</div></div>
        <div class="pnl-stat neutral">${tip('Total EQTY tokens moved across all trades in the period')}<div class="label">EQTY Vol</div><div class="value">${Math.round(s.totalEqtyVol).toLocaleString()}</div><div class="sub">tokens moved</div></div>
        <div class="pnl-stat neutral">${tip('Weighted average price paid per EQTY across all buy orders')}<div class="label">Avg Buy</div><div class="value">${s.avgBuyPrice>0?s.avgBuyPrice.toFixed(6):'\u2014'}</div><div class="sub">${Math.round(s.buyQty).toLocaleString()} EQTY</div></div>
        <div class="pnl-stat neutral">${tip('Weighted average price received per EQTY across all sell orders')}<div class="label">Avg Sell</div><div class="value">${s.avgSellPrice>0?s.avgSellPrice.toFixed(6):'\u2014'}</div><div class="sub">${Math.round(s.sellQty).toLocaleString()} EQTY</div></div>
        <div class="pnl-stat ${cls(s.tradePnl)}">${tip('Sell revenue minus buy cost \u2014 gross profit before fees are deducted')}<div class="label">Trade P&L</div><div class="value">${fmt(s.tradePnl)}</div><div class="sub">gross (pre-fee)</div></div>
        <div class="pnl-stat negative">${tip('Total trading fees paid to the exchange across all trades')}<div class="label">Fees Paid</div><div class="value">-$${s.totalFees.toFixed(4)}</div><div class="sub">${(s.totalFees/s.totalVolume*100).toFixed(2)}% effective</div></div>
        <div class="pnl-stat ${cls(s.netPnl)} highlight">${tip('Trade P&L after deducting all fees paid to the exchange')}<div class="label">Net P&L</div><div class="value">${fmt(s.netPnl)}</div><div class="sub">after fees</div></div>
        <div class="pnl-stat ${cls(tpnl)} highlight">${tip('Net P&L + value of unsold EQTY inventory at current mid price \u2014 most accurate profitability view')}<div class="label">True P&L</div><div class="value">${fmt(tpnl)}</div><div class="sub" style="font-size:10px;">${mp>0?`cash ${s.netEqtyChange>=0?'+':''}${Math.round(s.netEqtyChange).toLocaleString()} EQTY @ ${mp.toFixed(6)}`:'load bot status first'}</div></div>
        <div class="pnl-stat ${cls(ret)} highlight">${tip('Net P&L expressed as a percentage of total portfolio value')}<div class="label">Return %</div><div class="value">${fp(ret)}</div><div class="sub">${pv>0?`on $${pv.toFixed(0)}`:'load balance first'}</div></div>
        <div class="pnl-stat ${ic}">${tip('Net change in EQTY holdings: positive = accumulating tokens, negative = distributing them into the market')}<div class="label">Net EQTY \u0394</div><div class="value">${s.netEqtyChange>=0?'+':''}${Math.round(s.netEqtyChange).toLocaleString()}</div><div class="sub">${s.netEqtyChange>0?'\u2191 accumulating':s.netEqtyChange<0?'\u2193 distributing':'= neutral'}</div></div>
      </div>`;
    }
    async function loadKucoinData(days=1){
      document.querySelectorAll('#kucoin-days-selector .days-btn').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.days)===days));
      const el=document.getElementById('kucoin-content'),pe=document.getElementById('kucoin-pnl');
      el.classList.remove('error');el.classList.add('loading');el.textContent='Loading...';
      if(pe){pe.classList.add('loading');pe.textContent='Computing P&L...';}
      try{
        const data=await fetchWithAuth(`/bot-orchestration/ea5d7b611fd1da6ad5bffd559bac3c0ed6ed11d0/history?days=${days}&verbose=false&timeout=30`);
        let t=data?.response?.data?.data?.trades||data?.response?.data?.trades||data?.data?.trades||data.trades||[];
        t=t.slice().sort((a,b)=>(b.trade_timestamp||b.timestamp||0)-(a.trade_timestamp||a.timestamp||0));
        renderPnlStats('kucoin-pnl',computePnlStats(t),window.kucoinPortfolioValue||window.eqtyBotMetrics?.total_value_usdt||0,window.eqtyBotMetrics?.mid_price||0);
        renderTradesTable('kucoin-content',t);
      }catch(e){el.classList.remove('loading');el.innerHTML=`<div class="error">Error: ${e.message}</div>`;if(pe){pe.classList.remove('loading');pe.innerHTML=`<div class="error">P&L error: ${e.message}</div>`;}}
    }
    async function loadGateioData(days=1){
      document.querySelectorAll('#gateio-days-selector .days-btn').forEach(b=>b.classList.toggle('active',parseInt(b.dataset.days)===days));
      const el=document.getElementById('gateio-content'),pe=document.getElementById('gateio-pnl');
      el.classList.remove('error');el.classList.add('loading');el.textContent='Loading...';
      if(pe){pe.classList.add('loading');pe.textContent='Computing P&L...';}
      try{
        const data=await fetchWithAuth(`/bot-orchestration/da6132e324292f6f7b914b58333808506f741db0/history?days=${days}&verbose=false&timeout=30`);
        let t=data?.response?.data?.data?.trades||data?.response?.data?.trades||data?.data?.trades||data.trades||[];
        t=t.slice().sort((a,b)=>(b.trade_timestamp||b.timestamp||0)-(a.trade_timestamp||a.timestamp||0));
        renderPnlStats('gateio-pnl',computePnlStats(t),window.gateioPortfolioValue||window.gateioMetrics?.total_value_usdt||0,window.gateioMetrics?.mid_price||0);
        renderTradesTable('gateio-content',t);
      }catch(e){el.classList.remove('loading');el.innerHTML=`<div class="error">Error: ${e.message}</div>`;if(pe){pe.classList.remove('loading');pe.innerHTML=`<div class="error">P&L error: ${e.message}</div>`;}}
    }




    // -------- Initial load --------
    refreshAll();
    fetchBotRunningStatus();
    setInterval(fetchBotRunningStatus, REFRESH_INTERVAL);
  </script>
</body>
</html>



